#! /bin/zsh

routesms_success=1701

# TODO: change this to actual directory
conf=etc/sms.conf

url=$(< $conf grep ^url= | cut -d'=' -f2)
if [[ -z $url ]]; then
    print "RouteSMS URL missing from config" >&2
    exit 1
fi

username=$(< $conf grep ^username= | cut -d'=' -f2)
if [[ -z $username ]]; then
    print "RouteSMS username missing from config" >&2
    exit 1
fi

password=$(< $conf grep ^password= | cut -d'=' -f2)
if [[ -z $password ]]; then
    print "RouteSMS password missing from config" >&2
    exit 1
fi

destination=$1
if [[ -z $destination ]]; then
    print "No destination specified" >&2
    exit 1
elif [[ ! $destination =~ ^\\+[0-9]+$ ]]; then
    print "Phone number is not valid" >&2
    exit 1
fi

message=$2
if [[ -z $message ]]; then
    print "No message specified" >&2
    exit 1
fi

# TODO: for now we only support RouteSMS. Maybe others in the future?
response=$(curl -s -X GET -G $url \
    --data-urlencode "username=$username" \
    --data-urlencode "password=$password" \
    --data-urlencode "type=0" \
    --data-urlencode "dlr=1" \
    --data-urlencode "destination=$destination" \
    --data-urlencode "source=Delaphone" \
    --data-urlencode "message=$2")

$code=$(print $response | cut -d'|' -f1)
if [[ $code -eq $routesms_success ]]; then
    exit 0
else
    print $code >&2
    exit 1
fi
